## è¯•é¢˜ä¸€

## å­˜åœ¨é—®é¢˜

å…¨å±€å˜é‡ä½¿ç”¨ä¸å½“

### å…·ä½“åˆ†æ

`tx.origin`ä¸`msg.sender`çš„ä½¿ç”¨é—®é¢˜ï¼š

`tx.origin`æ˜¯æ•´ä¸ªè°ƒç”¨é“¾ä¸Šæœ€å¼€å§‹çš„ç”¨æˆ·åœ°å€ã€‚

`msg.sender`æ˜¯å½“å‰å‡½æ•°çš„ç›´æ¥è°ƒç”¨è€…çš„åœ°å€ï¼ˆå¯ä»¥æ˜¯ç”¨æˆ·è°ƒç”¨ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆçº¦é—´æ¥è°ƒç”¨ï¼‰ã€‚

### è§£å†³åŠæ³•

æ ¹æ®å…·ä½“ä¸šåŠ¡æƒ…å†µæ…é‡ä½¿ç”¨è¿™ä¸ªä¸¤ä¸ªå…¨å±€å˜é‡ã€‚

> å¤§å¤šæ•°æƒ…å†µï¼Œå°¤å…¶æ˜¯æ¶‰åŠ**èº«ä»½éªŒè¯**ã€**æƒé™æ§åˆ¶**æˆ–**åˆ†å‘èµ„é‡‘**çš„æ“ä½œéƒ½åº”è¯¥ä¼˜å…ˆä½¿ç”¨`msg.sender`ã€‚



## å·ä¸€



## å·äºŒ

### å­˜åœ¨é—®é¢˜

- æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·è¾“å…¥

- æ•æ„Ÿæ“ä½œæ²¡æœ‰æƒé™æ ¡éªŒï¼ˆå¯é€‰ï¼‰

- æ²¡æœ‰è€ƒè™‘æ•´å‹æ•°æ®æº¢å‡ºé—®é¢˜ï¼ˆå¯é€‰ï¼‰

### å…·ä½“åˆ†æ

æœ€ä¸¥é‡çš„é—®é¢˜æ˜¯æ²¡æœ‰å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œæ£€æŸ¥ã€‚

![image.png](https://img13.360buyimg.com/ddimg/jfs/t1/238373/37/5950/6974/6577b971Fb807f6cb/de3141a256f87491.jpg)

å¦‚æœç”¨æˆ·è¾“å…¥æ˜¯è´Ÿæ•°åˆ™ä¼šå¯¼è‡´å†»ç»“æ—¶é—´å‡å°‘ç”šè‡³ç›´æ¥æ¶ˆå¤±ã€‚

è¿™é‡Œçš„æ”»å‡»æ‰‹æ®µå°±æ˜¯åˆ©ç”¨äº†æ•´å‹æ•°æ®çš„æº¢å‡ºã€‚

![image.png](https://img10.360buyimg.com/ddimg/jfs/t1/221933/27/38861/3008/6577b8b7Fc9186d05/cb7044fcb3297f1d.jpg)

![image.png](https://img12.360buyimg.com/ddimg/jfs/t1/232547/10/7250/5459/6577ba6fFf5b90ba3/77e16babbc4778e9.jpg)

lockTimeæ˜¯ä¸€ä¸ªuintç±»å‹çš„æ•°æ®ã€‚è€Œuintæ•°æ®æ˜¯å°†ç¬¬ä¸€ä½ç¬¦å·ä½ä¹Ÿçœ‹ä½œæ˜¯æ•°æ®ä½ã€‚å°†uintå–æœ€å¤§å€¼+1ï¼Œå¯¼è‡´æ•°æ®æº¢å‡ºç›´æ¥å˜æˆ0ï¼Œå†å‡å»å†»ç»“æ—¶é—´ï¼Œç»“æœå°±æ˜¯å½“å‰å†»ç»“æ—¶é—´çš„ç›¸åæ•°ã€‚ç”¨è¿™ä¸ªæ•°å½“ä½œå‚æ•°è°ƒç”¨`increaseLockTime`ï¼Œå¯¼è‡´å†»ç»“æ—¶é—´ç›´æ¥æ¸…é›¶ã€‚

> å¯¹æ•´å‹æ•°è¿ç®—æœ‰å…´è¶£çš„è‡ªè¡Œè¡¥å……è®¡ç®—æœºåŸç†ç›¸å…³çŸ¥è¯†ã€‚

### å¤„ç†æ–¹æ³•

- Solidity `0.8.0` ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œåœ¨åˆçº¦ä¸­å¼•ç”¨ Safemath åº“ï¼Œåœ¨æ•´å‹æº¢å‡ºæ—¶æŠ¥é”™ã€‚
- Solidity `0.8.0` ä¹‹åçš„ç‰ˆæœ¬å†…ç½®äº† `Safemath`ï¼Œå› æ­¤å‡ ä¹ä¸å­˜åœ¨è¿™ç±»é—®é¢˜ã€‚å¼€å‘è€…æœ‰æ—¶ä¼šä¸ºäº†èŠ‚çœgasä½¿ç”¨ `unchecked` å…³é”®å­—åœ¨ä»£ç å—ä¸­ä¸´æ—¶å…³é—­æ•´å‹æº¢å‡ºæ£€æµ‹ï¼Œè¿™æ—¶è¦ç¡®ä¿ä¸å­˜åœ¨æ•´å‹æº¢å‡ºæ¼æ´ã€‚



## å·ä¸‰

### å­˜åœ¨é—®é¢˜

ç”±äºæœ¬èº«å­˜åœ¨èµ„é‡‘é”æ­»æœºåˆ¶ï¼Œä½†ä¸èƒ½é˜»æ­¢èµ„é‡‘çš„å¼ºåˆ¶æ±‡å…¥ï¼Œä»è€Œèµ„é‡‘é”æ­»çŠ¶æ€ã€‚

### å…·ä½“åˆ†æ

`slefdestruct`æ˜¯ä»¥å¤ªåŠçš„åº•å±‚ï¼ˆä½çº§åˆ«ï¼‰æ“ä½œï¼Œæ²¡æœ‰ç›´æ¥æ‰‹æ®µå¯ä»¥é˜»æ­¢ã€‚æ”»å‡»è€…åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å‘å…·æœ‰**èµ„é‡‘é”æ­»æœºåˆ¶**çš„åˆçº¦ä¸­è¿›è¡Œæ³¨å…¥ï¼Œå¯¼è‡´è¯¥åˆçº¦ä¸­æ‰€æœ‰çš„èµ„é‡‘å…¨éƒ¨é”æ­»ã€‚

> ä¸è¿‡çœŸçš„è¦åæ§½ä¸€ä¸‹ï¼šè™½ç„¶ç¡®å®æ˜¯ä¸ªæ¼æ´å§ï¼Œä½†èƒ½åˆ©ç”¨è¿™ç§ä¸¤è´¥ä¿±ä¼¤çš„æ”»å‡»æ‰‹æ®µçš„äººä¹ŸçœŸçš„ç–¯ç‹‚ï¼ç”¨æˆ‘çš„é’±é”æ­»ä½ çš„é’±ï¼Œå£•æ— äººæ€§å•ŠğŸ˜­ã€‚

```solidity
pragma solidity ^0.8.3;
contract EtherGame {
    uint public targetAmount = 7 ether;
    address public winner;
	
	// å­˜é’±
    function deposit() public payable {
        require(msg.value == 1 ether, "You can only send 1 Ether");
        uint balance = address(this).balance;
        // æ­»é”æœºåˆ¶ï¼šä½™é¢è¶…è¿‡ç›®æ ‡é¢åº¦èµ„æºæ— æ³•æ­£å¸¸æ±‡å…¥
        // å¼ºåˆ¶æ³¨å…¥å¯¼è‡´åˆçº¦ä½™é¢è¶…è¿‡ç›®æ ‡é¢åº¦ï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰èµ¢å®¶äº§ç”Ÿï¼Œæ— æ³•å°†åˆçº¦ä¸­çš„èµ„é‡‘å–èµ°ï¼Œåˆçº¦ä¸­çš„èµ„é‡‘è¿›å…¥æ­»é”ï¼ˆä¸èƒ½å­˜å–ï¼‰
        require(balance <= targetAmount, "Game is over");
        if (balance == targetAmount) {
            winner = msg.sender;
        }
    }
    
    // èµ¢å®¶å–èµ°å…¨éƒ¨èµ„é‡‘
    function claimReward() public {
        require(msg.sender == winner, "Not winner");
        (bool sent, ) = msg.sender.call{value: address(this).balance}("");
        require(sent, "Failed to send Ether");
    }
}
```

### å¤„ç†åŠæ³•

**å¢åŠ å®‰å…¨æ ¡éªŒæœºåˆ¶**

æ—¢ç„¶åˆçº¦çš„çœŸå®ä½™é¢æ˜¯ä¸èƒ½é˜²æ­¢å¼ºåˆ¶æ±‡å…¥çš„ï¼Œé‚£æˆ‘ä»¬å°±æ–°å¢ä¸€ä¸ª**è‡ªå®šä¹‰ä½™é¢**ï¼Œé€šè¿‡è‡ªå®šä¹‰ä½™é¢å¯¹åˆçº¦çŠ¶æ€è¿›è¡Œç®¡ç†ã€‚

```solidity
pragma solidity ^0.8.3;
contract EtherGame {
    uint public targetAmount = 7 ether;
    // è‡ªå®šä¹‰ä½™é¢
    uint private balance = 0; 
    address public winner;

    function deposit() public payable {
        require(msg.value == 1 ether, "You can only send 1 Ether");
        // æ“ä½œè‡ªå®šä¹‰ä½™é¢
        balance += msg.value;
        require(balance <= targetAmount, "Game is over");
        if (balance == targetAmount) {
            winner = msg.sender;
        }
    }
    
    function claimReward() public {
        require(msg.sender == winner, "Not winner");
        (bool sent, ) = msg.sender.call{value: address(this).balance}("");
        require(sent, "Failed to send Ether");
    }
}
```



## é‡å…¥æ”»å‡»

```solidity
contract Bank {
    mapping (address => uint256) public balanceOf;    // ä½™é¢mapping

    // å­˜å…¥etherï¼Œå¹¶æ›´æ–°ä½™é¢
    function deposit() external payable {
        balanceOf[msg.sender] += msg.value;
    }

    // æå–msg.senderçš„å…¨éƒ¨ether
    function withdraw() external {
        uint256 balance = balanceOf[msg.sender]; // è·å–ä½™é¢
        require(balance > 0, "Insufficient balance");
        // å­˜åœ¨é‡å…¥æ”»å‡»é£é™©
        (bool success, ) = msg.sender.call{value: balance}("");
        require(success, "Failed to send Ether");
        // æ›´æ–°ä½™é¢
        balanceOf[msg.sender] = 0;
    }

    // è·å–é“¶è¡Œåˆçº¦çš„ä½™é¢
    function getBalance() external view returns (uint256) {
        return address(this).balance;
    }
}

contrack Attack {
	// å›è°ƒå‡½æ•°ï¼Œç”¨äºé‡å…¥æ”»å‡»Bankåˆçº¦ï¼Œåå¤çš„è°ƒç”¨ç›®æ ‡çš„withdrawå‡½æ•°
    receive() external payable {
        if (bank.getBalance() >= 1 ether) {
            bank.withdraw();
        }
    }

	// æ”»å‡»å‡½æ•°ï¼Œè°ƒç”¨æ—¶ msg.value è®¾ä¸º 1 ether
    function attack() external payable {
        require(msg.value == 1 ether, "Require 1 Ether to attack");
        bank.deposit{value: 1 ether}();
        bank.withdraw();
    }
}
```



### å­˜åœ¨é—®é¢˜

- ä¸šåŠ¡è®¾è®¡æ¼æ´
- `fallback`å›é€€å‡½æ•°
- å–æ¬¾æ“ä½œæ²¡æœ‰ä½¿ç”¨é‡å…¥é”

### å…·ä½“åˆ†æ

é‡å…¥æ”»å‡»æ ¹æœ¬çš„è®²ï¼Œå…¶å®æ˜¯åˆ©ç”¨äº†ä¸šåŠ¡æ¼æ´ã€‚

å°†é“¶è¡Œçš„è¥ä¸šå‘˜å…¨éƒ¨æƒ³è±¡æˆæœºå™¨äººï¼ˆå‡½æ•°å°±æ˜¯ç”¨æˆ·è§¦å‘åè¿›è¡Œå·¥ä½œï¼‰ã€‚

ä¸€èˆ¬çš„ç”¨æˆ·å–æ¬¾æµç¨‹æ˜¯ï¼š

1. ç”¨æˆ·è°ƒç”¨å–æ¬¾å‡½æ•°
2. è½¬è´¦åˆ°ç”¨æˆ·åœ°å€
3. æ›´æ–°ä½™é¢

![ä¸€èˆ¬å–æ¬¾æµç¨‹.png](https://img11.360buyimg.com/ddimg/jfs/t1/234956/12/8384/20787/657af6c2Fdd7a8e17/c9dd3ff6f69fbad1.jpg)

ä½†å¦‚æœæ”¶æ¬¾çš„åœ°å€æ˜¯ä¸€ä¸ªåˆçº¦çš„è¯ï¼Œå°±ä¼šå­˜åœ¨ä¸€ä¸ªå¾ˆ**ä¸¥é‡çš„é—®é¢˜**ã€‚è¿™å¾—æåˆ°åˆçº¦çš„ä¸€ä¸ªæœºåˆ¶â€”â€”åˆçº¦çš„å›è°ƒå‡½æ•°ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼šå½“åˆçº¦æ”¶åˆ°ä¸€ä»½è½¬è´¦çš„æ—¶å€™ï¼Œæ ¹æ®`msg.data`çš„çŠ¶æ€åŠåˆçº¦æ˜¯å¦å­˜åœ¨`receive()`å‡½æ•°å†³å®šè°ƒç”¨`receive()`å‡½æ•°è¿˜æ˜¯`fallback()`å‡½æ•°ã€‚

> æ³¨æ„âš ï¸ï¼šåœ¨Solidity 0.6.xç‰ˆæœ¬ä¹‹å‰ï¼Œè¯­æ³•ä¸Šåªæœ‰ `fallback()` å‡½æ•°ï¼Œç”¨æ¥æ¥æ”¶ç”¨æˆ·å‘é€çš„ETHæ—¶è°ƒç”¨ä»¥åŠåœ¨è¢«è°ƒç”¨å‡½æ•°ç­¾åæ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œæ¥è°ƒç”¨ã€‚ 0.6ç‰ˆæœ¬ä¹‹åï¼ŒSolidityæ‰å°† `fallback()` å‡½æ•°æ‹†åˆ†æˆ `receive()` å’Œ `fallback()` ä¸¤ä¸ªå‡½æ•°ã€‚

<img src="https://img11.360buyimg.com/ddimg/jfs/t1/123723/36/38237/20551/657af8bdF40f99141/8a231744be4c5a8c.jpg" alt="falback.png" style="zoom: 50%;" />

**æ³¨æ„ï¼é‡å…¥æ”»å‡»æ¥äº†**ï¼šå‡è®¾å½“æœºå™¨äººè½¬è´¦è¿‡æ¥çš„æ—¶å€™è°ƒç”¨çš„æ˜¯`fallback()`å›é€€å‡½æ•°ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨`fallback`ä¸­å†æ¬¡è°ƒç”¨é“¶è¡Œçš„å–æ¬¾å‡½æ•°ï¼Œå¹¶å–å‡ºç›¸åŒçš„æ•°é‡ã€‚æ­¤æ—¶ï¼Œç”±äºæœºå™¨äººè¿˜æ²¡æœ‰æ‰§è¡Œåˆ°æ›´æ–°ä½™é¢çš„å‡½æ•°ï¼Œè®¤ä¸ºè¯¥ç”¨æˆ·è´¦æˆ·ä¸­è¿˜æœ‰è¶³å¤Ÿçš„ä½™é¢ï¼Œå°†ä¼šå†æ¬¡å¯¹ç”¨æˆ·è¿›è¡Œè½¬è´¦ã€‚ä¸æ–­å¾ªç¯å–æ¬¾æ“ä½œï¼Œç›´åˆ°æç©ºé“¶è¡Œçš„å…¨éƒ¨ä½™é¢ã€‚ğŸ˜µ

### å¤„ç†æ–¹æ³•

å›å¿†ä¸€ä¸‹è¯¥æ”»å‡»çš„æ”»å‡»ç‚¹ï¼šåˆ©ç”¨åˆçº¦æ”¶åˆ°è½¬è´¦åçš„`fallback()`å†æ¬¡å–æ¬¾ï¼Œé€šè¿‡é“¶è¡Œä¸­ç”¨æˆ·ä½™é¢æ›´æ–°ä¸åŠæ—¶è½¬ç§»è´§å¸ã€‚

ç›®å‰æœ‰ä¸¤ç§è§£å†³æ–¹å¼ï¼š

- ä½¿ç”¨**æ£€æŸ¥-å½±å“-äº¤äº’æ¨¡å¼**ï¼šä¿®æ”¹ä¸šåŠ¡æµç¨‹ï¼Œå¼¥è¡¥ç”¨æˆ·ä½™é¢æ›´æ–°ä¸åŠæ—¶çš„æ¼æ´ï¼š

  1. ç”¨æˆ·å–æ¬¾
  2. æ›´æ–°ç”¨æˆ·ä½™é¢
  3. è½¬è´¦

- ä½¿ç”¨**é‡å…¥é”**ï¼šä½¿ç”¨ä¿®é¥°ç¬¦å¯ä»¥åœ¨å‡½æ•°æ‰§è¡Œå…ˆåæ‰§è¡Œçš„ç‰¹æ€§ï¼Œåœ¨å‡½æ•°æ‰§è¡Œå‰ï¼Œä¿®æ”¹å‡½æ•°æ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åè¿˜åŸï¼Œå¹¶ä¸”å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹å‡½æ•°æ‰§è¡ŒçŠ¶æ€è¿›è¡Œæ ¡éªŒã€‚

  ```solidity
  contract Bank{
  	uint256 private _status; // å‡½æ•°æ‰§è¡ŒçŠ¶æ€
  
      // é‡å…¥é”
      modifier nonReentrant() {
          // åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ nonReentrant æ—¶ï¼Œ_status å°†æ˜¯ 0
          require(_status == 0, "ReentrancyGuard: reentrant call");
          // åœ¨æ­¤ä¹‹åå¯¹ nonReentrant çš„ä»»ä½•è°ƒç”¨éƒ½å°†å¤±è´¥
          _status = 1;
          _;
          // è°ƒç”¨ç»“æŸï¼Œå°† _status æ¢å¤ä¸º0
          _status = 0;
  	}
  }
  ```

- PullPayment(æ‹‰å–æ”¯ä»˜)æ¨¡å¼ï¼š

  OpenZeppelinä¹Ÿæå€¡éµå¾ªPullPayment(æ‹‰å–æ”¯ä»˜)æ¨¡å¼ä»¥é¿å…æ½œåœ¨çš„é‡å…¥æ”»å‡»ã€‚å…¶åŸç†æ˜¯é€šè¿‡å¼•å…¥ç¬¬ä¸‰æ–¹(escrow)ï¼Œå°†åŸå…ˆçš„â€œä¸»åŠ¨è½¬è´¦â€åˆ†è§£ä¸ºâ€œ**è½¬è´¦è€…å‘èµ·è½¬è´¦**â€åŠ ä¸Šâ€œ**æ¥å—è€…ä¸»åŠ¨æ‹‰å–**â€ã€‚å½“æƒ³è¦å‘èµ·ä¸€ç¬”è½¬è´¦æ—¶ï¼Œä¼šé€šè¿‡`_asyncTransfer(address dest, uint256 amount)`å°†å¾…è½¬è´¦é‡‘é¢å­˜å‚¨åˆ°ç¬¬ä¸‰æ–¹åˆçº¦ä¸­ï¼Œä»è€Œé¿å…å› é‡å…¥å¯¼è‡´çš„è‡ªèº«èµ„äº§æŸå¤±ã€‚è€Œå½“æ¥å—è€…æƒ³è¦æ¥å—è½¬è´¦æ—¶ï¼Œéœ€è¦ä¸»åŠ¨è°ƒç”¨`withdrawPayments(address payable payee)`è¿›è¡Œèµ„äº§çš„ä¸»åŠ¨è·å–ã€‚

  > é“¶è¡Œè½¬è´¦åˆ°ç¬¬ä¸‰æ–¹æ—¶ä¸ä¼šå¼•èµ·ç”¨æˆ·åˆçº¦çš„`receive()`æˆ–`fallback()`å‡½æ•°ï¼Œä»è€Œé¿å…äº†é‡å…¥æ”»å‡»ã€‚
